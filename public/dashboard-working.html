<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate KPI Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Dark mode styles */
        .dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .dark-mode .container {
            background: #2d2d2d;
        }

        .dark-mode .header h1 {
            color: #e0e0e0;
        }

        .dark-mode .tab {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .dark-mode .tab.active {
            background: #4a4a4a;
            color: white;
        }

        .dark-mode .tab:hover {
            background: #4a4a4a;
        }

        .dark-mode .card {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .dark-mode .card h3 {
            color: #e0e0e0;
        }

        .dark-mode .form-section {
            background: #3a3a3a;
        }

        .dark-mode .form-section h3 {
            color: #e0e0e0;
        }

        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: #555;
        }

        .dark-mode input:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            border-color: #3498db;
        }

        .dark-mode .table th,
        .dark-mode .table td {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        .dark-mode .table tr:hover {
            background: #4a4a4a;
        }

        .dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        /* Progress bar styles */
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-left: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #27ae60;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-fill.complete {
            background: #2ecc71;
        }

        .progress-fill.over {
            background: #f39c12;
        }

        #progressDisplay {
            padding: 15px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 3px solid #3498db;
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab:hover {
            background: #d5dbdb;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            align-items: center;
        }

        /* For reports tab with 2 cards */
        #reports .grid {
            grid-template-columns: repeat(2, minmax(250px, 300px));
            justify-content: center;
            max-width: 800px;
            margin: 0 auto 30px auto;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            #reports .grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }

        .card .label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.active-listing {
            background: #d1f2eb;
            color: #0e6656;
        }

        .status.sold {
            background: #cce5ff;
            color: #004085;
        }

        .status.closed {
            background: #cce5ff;
            color: #004085;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.under-contract {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.in-progress {
            background: #e2e3e5;
            color: #41464b;
        }

        .status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status.withdrawn {
            background: #d3d3d4;
            color: #495057;
        }

        .status.terminated {
            background: #f5c6cb;
            color: #721c24;
        }

        .status.new {
            background: #e2e3e5;
            color: #495057;
        }

        .status.contacted {
            background: #d4edda;
            color: #155724;
        }

        .status.qualified {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.hot {
            background: #f8d7da;
            color: #721c24;
        }

        .status.appointment-set {
            background: #fff3cd;
            color: #856404;
        }

        .status.converted {
            background: #d4edda;
            color: #155724;
        }

        .status.lost {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .edit-btn {
            background: #ffc107;
            color: #212529;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .view-btn {
            background: #17a2b8;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        /* Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }

        .dark-mode .progress-bar {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
            <h1>Real Estate KPI Dashboard</h1>
            <p>Last Updated: <span id="timestamp"></span></p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('goals', this)">Goals</button>
            <button class="tab" onclick="switchTab('transactions', this)">Transactions</button>
            <button class="tab" onclick="switchTab('properties', this)">Properties</button>
            <button class="tab" onclick="switchTab('dashboard', this)">Dashboard</button>
            <button class="tab" onclick="switchTab('expenses', this)">Expenses</button>
            <button class="tab" onclick="switchTab('gci-calculator', this)">GCI Calculator</button>
            <button class="tab" onclick="switchTab('calendar', this)">Activities</button>
            <button class="tab" onclick="switchTab('reports', this)">Reports</button>
        </div>

        <!-- Goals Tab -->
        <div id="goals" class="tab-content active">
            <h2>Goals & Targets</h2>
            <div class="grid">
                <div class="card">
                    <h3>Daily Goal</h3>
                    <div class="number" id="dailyGoal">10</div>
                    <div class="label">Calls per day</div>
                </div>
                <div class="card">
                    <h3>Weekly Goal</h3>
                    <div class="number" id="weeklyGoal">5</div>
                    <div class="label">Appointments per week</div>
                </div>
                <div class="card">
                    <h3>Monthly Goal</h3>
                    <div class="number" id="monthlyGoal">2</div>
                    <div class="label">Closings per month</div>
                </div>
                <div class="card">
                    <h3>Monthly Offers</h3>
                    <div class="number" id="monthlyOffersGoal">15</div>
                    <div class="label">Offers written per month</div>
                </div>
                <div class="card">
                    <h3>Annual GCI</h3>
                    <div class="number" id="annualGCI">$215K</div>
                    <div class="label">Target commission</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Update Your Goals</h3>
                <form id="goalsForm">
                    <div class="form-group">
                        <label>Daily Call Goal</label>
                        <input type="number" id="dailyCallGoal" value="10" placeholder="Enter daily call target">
                    </div>
                    <div class="form-group">
                        <label>Weekly Appointment Goal</label>
                        <input type="number" id="weeklyAppointmentGoal" value="5" placeholder="Enter weekly appointment target">
                    </div>
                    <div class="form-group">
                        <label>Monthly Closing Goal</label>
                        <input type="number" id="monthlyClosingGoal" value="2" placeholder="Enter monthly closing target">
                    </div>
                    <div class="form-group">
                        <label>Monthly Offers Written Goal</label>
                        <input type="number" id="monthlyOffersGoalInput" value="15" placeholder="Enter monthly offers target">
                    </div>
                    <div class="form-group">
                        <label>Annual GCI Goal</label>
                        <input type="number" id="annualGCIGoal" value="215000" placeholder="Enter annual GCI target">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button type="submit" class="btn">Update Goals</button>
                        <button type="button" class="btn" onclick="lockGoals()" id="lockGoalsBtn" style="background: #e74c3c;">Lock Goals</button>
                        <div id="goalsLockStatus" style="font-weight: bold; color: #27ae60;">Unlocked</div>
                    </div>
                </form>
            </div>
        </div>

        <!-- GCI Calculator Tab -->
        <div id="gci-calculator" class="tab-content">
            <h2>GCI Calculator & Analysis</h2>
            
            <div class="form-section">
                <h3>Current Status</h3>
                <div class="grid">
                    <div class="card">
                        <h3>Annual Goal</h3>
                        <div class="number">$215K</div>
                        <div class="label">GCI target</div>
                    </div>
                    <div class="card">
                        <h3>Current GCI</h3>
                        <div class="number" id="currentGCIDisplay">$105K</div>
                        <div class="label">Year-to-date</div>
                    </div>
                    <div class="card">
                        <h3>Remaining</h3>
                        <div class="number" id="remainingGCIDisplay">$110K</div>
                        <div class="label">Still needed</div>
                    </div>
                    <div class="card">
                        <h3>Progress</h3>
                        <div class="number" id="gciProgressDisplay">49%</div>
                        <div class="label">Toward goal</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="gciProgressFill" style="width: 49%"></div>
                </div>
                <p style="text-align: center; margin-top: 10px; font-weight: 600;" id="gciProgressText">49% Complete - $105,000 of $215,000 goal</p>
            </div>

            <div class="form-section">
                <h3>GCI Projection Calculator</h3>
                <div class="form-group">
                    <label>Average Sale Price</label>
                    <input type="number" id="avgPrice" value="350000" placeholder="Enter average sale price">
                </div>
                <div class="form-group">
                    <label>Commission Rate (%)</label>
                    <input type="number" id="commissionRate" value="2.5" step="0.1" placeholder="Enter commission rate">
                </div>
                <div class="form-group">
                    <label>Annual GCI Goal</label>
                    <input type="number" id="gciGoal" value="215000" placeholder="Enter annual GCI goal">
                </div>
                <div class="form-group">
                    <label>Deals Needed</label>
                    <input type="number" id="dealsNeeded" value="13" readonly>
                </div>
                <button class="btn" onclick="calculateGCI()">Recalculate</button>
            </div>
        </div>

        <!-- Properties Tab -->
        <div id="properties" class="tab-content">
            <h2>Property Management</h2>
            
            <div class="alert" style="background: #e7f3ff; border: 1px solid #b8daff; color: #004085; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <strong>Note:</strong> Property management has been moved to the Transactions tab for better workflow integration. You can add and manage properties directly from the Transactions section.
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <h2>Transaction History</h2>
            <div class="grid">
                <div class="card">
                    <h3>Total Transactions</h3>
                    <div class="number" id="totalTransactions">12</div>
                    <div class="label">This year</div>
                </div>
                <div class="card">
                    <h3>Total Volume</h3>
                    <div class="number" id="transactionTotalVolume">$4.2M</div>
                    <div class="label">Transaction volume</div>
                </div>
                <div class="card">
                    <h3>Commission Earned</h3>
                    <div class="number" id="commissionEarned">$105K</div>
                    <div class="label">Total commission</div>
                </div>
                <div class="card">
                    <h3>Average Deal</h3>
                    <div class="number" id="transactionAverageDeal">$350K</div>
                    <div class="label">Average transaction</div>
                </div>
            </div>

            <div class="alert" style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <strong>Great Progress!</strong> You've earned $105,000 in commission so far this year, putting you at 49% of your annual goal.
            </div>

            <div class="form-section">
                <h3>Add New Property</h3>
                <form id="combinedForm">
                    <!-- Property Information Section -->
                    <fieldset style="border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <legend style="padding: 0 10px; font-weight: bold; color: #333;">Property Information</legend>
                        <div class="form-group">
                            <label>Property Address *</label>
                            <input type="text" id="propertyAddress" placeholder="Enter property address" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name *</label>
                            <input type="text" id="clientName" placeholder="Enter client name" required>
                        </div>
                        <div class="form-group">
                            <label>Property Type *</label>
                            <select id="propertyType" required>
                                <option value="">Select type</option>
                                <option value="Buyer">Buyer</option>
                                <option value="Seller">Seller</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Property Price *</label>
                            <input type="number" id="propertyPrice" placeholder="Enter property price" required>
                        </div>
                        <div class="form-group">
                            <label>Transaction Status *</label>
                            <select id="propertyStatus" required>
                                <option value="">Select status</option>
                                <option value="Active">Active</option>
                                <option value="Active Listing">Active Listing</option>
                                <option value="Pending">Pending</option>
                                <option value="Under Contract">Under Contract</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Sold">Sold</option>
                                <option value="Closed">Closed</option>
                                <option value="Expired">Expired</option>
                                <option value="Withdrawn">Withdrawn</option>
                                <option value="Terminated">Terminated</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Property Status Note</label>
                            <textarea id="statusNote" placeholder="Enter property status note or reason (optional)" rows="2"></textarea>
                        </div>
                    </fieldset>

                    <button type="button" class="btn" onclick="addCombined(event)">Add Property</button>
                </form>
            </div>

            <div id="transactionTableContainer">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Property</th>
                            <th>Amount</th>
                            <th>Commission</th>
                            <th>Status</th>
                            <th>Status Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="propertyTableContainer">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Client</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Status Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="propertyTableBody">
                        <!-- Properties will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2>Dashboard Overview</h2>
            <div class="grid">
                <div class="card">
                    <h3>Active Listings</h3>
                    <div class="number" id="activeListings">0</div>
                    <div class="label">Properties active</div>
                </div>
                <div class="card">
                    <h3>Under Contract</h3>
                    <div class="number" id="underContract">0</div>
                    <div class="label">Properties under contract</div>
                </div>
                <div class="card">
                    <h3>Expired</h3>
                    <div class="number" id="expiredListings">0</div>
                    <div class="label">Expired listings</div>
                </div>
                <div class="card">
                    <h3>Withdrawn</h3>
                    <div class="number" id="withdrawnListings">0</div>
                    <div class="label">Withdrawn listings</div>
                </div>
                <div class="card">
                    <h3>Terminated</h3>
                    <div class="number" id="terminatedListings">0</div>
                    <div class="label">Terminated listings</div>
                </div>
                <div class="card">
                    <h3>Closed This Month</h3>
                    <div class="number" id="closedThisMonth">0</div>
                    <div class="label">Transactions closed</div>
                </div>
                <div class="card">
                    <h3>Total Volume</h3>
                    <div class="number" id="totalVolume">$0</div>
                    <div class="label">Sales volume</div>
                </div>
                <div class="card">
                    <h3>Total Commission</h3>
                    <div class="number" id="totalCommission">$0</div>
                    <div class="label">Commission earned</div>
                </div>
                <div class="card">
                    <h3>Total Expenses</h3>
                    <div class="number" id="totalExpenses">$0</div>
                    <div class="label">All expenses</div>
                </div>
                <div class="card">
                    <h3>ROI</h3>
                    <div class="number" id="roi">0%</div>
                    <div class="label">Return on Investment</div>
                </div>
                <div class="card">
                    <h3>Average Deal Size</h3>
                    <div class="number" id="averageDeal">$0</div>
                    <div class="label">Avg transaction</div>
                </div>
                <div class="card">
                    <h3>Net Profit</h3>
                    <div class="number" id="netProfit">$0</div>
                    <div class="label">Commission - Expenses</div>
                </div>
                <div class="card">
                    <h3>Annual GCI Goal</h3>
                    <div class="number" id="annualGCIProgress">$215K / $215K</div>
                    <div class="label">
                        <span id="gciProgressPercent">49%</span> to goal
                        <div style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 5px;">
                            <div id="gciProgressBar" style="width: 49%; height: 100%; background: #27ae60; border-radius: 2px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>GCI Progress</h3>
                    <div class="number" id="gciProgress">0%</div>
                    <div class="label">Annual goal progress</div>
                </div>
                <div class="card">
                    <h3>Conversion Rate</h3>
                    <div class="number" id="dashboardConversionRate">0%</div>
                    <div class="label">Buyers/Sellers to closed</div>
                </div>
                <div class="card">
                    <h3>Average Days on Market</h3>
                    <div class="number" id="dashboardAvgDaysOnMarket">0</div>
                    <div class="label">Under Contract to Closed</div>
                </div>
            </div>
            
            <h3>Activity Overview</h3>
            <div class="grid">
                <div class="card">
                    <h3>Property Showings</h3>
                    <div class="number" id="propertyShowings">0</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Listing Presentations</h3>
                    <div class="number" id="listingPresentations">0</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Buyer Consultations</h3>
                    <div class="number" id="buyerConsultations">0</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Closings</h3>
                    <div class="number" id="activityClosings">0</div>
                    <div class="label">This month</div>
                </div>
            </div>
        </div>

        <!-- Daily Data Tab -->
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <h2>Expense Tracking</h2>
            
            <div id="expenseTableContainer">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Property</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                        <!-- Expenses will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="form-section">
                <h3>Add New Expense</h3>
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Property *</label>
                        <select id="expenseProperty" required>
                            <option value="">Select property</option>
                            <!-- Properties will be populated here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="expenseCategory" required>
                            <option value="">Select category</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Mileage">Mileage</option>
                            <option value="Office">Office</option>
                            <option value="Professional Photography">Professional Photography</option>
                            <option value="Staging">Staging</option>
                            <option value="Meals">Meals</option>
                            <option value="Equipment Rental">Equipment Rental</option>
                            <option value="Repairs">Repairs</option>
                            <option value="Legal">Legal</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="expenseAmount" placeholder="Enter amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="expenseDescription" placeholder="Enter description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Mileage (miles)</label>
                        <input type="number" id="expenseMileage" placeholder="Enter mileage" step="0.1" onchange="calculateMileageCost()">
                    </div>
                    <div class="form-group">
                        <label>Gas Price (per gallon)</label>
                        <input type="number" id="expenseGasPrice" placeholder="Enter current gas price" step="0.01" onchange="calculateMileageCost()">
                    </div>
                    <div class="form-group">
                        <label>Miles Per Gallon (MPG)</label>
                        <input type="number" id="expenseMPG" placeholder="Enter your car's MPG" step="0.1" value="20" onchange="calculateMileageCost()">
                    </div>
                    <div class="form-group">
                        <label>Calculated Mileage Cost</label>
                        <input type="number" id="expenseMileageCost" placeholder="Auto-calculated" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label>Travel Hours</label>
                        <input type="number" id="expenseTravelHours" step="0.25" placeholder="Enter travel hours">
                    </div>
                    <div class="form-group">
                        <label>Hours Worked</label>
                        <input type="number" id="expenseHoursWorked" placeholder="Enter hours worked" step="0.25">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate</label>
                        <input type="number" id="expenseHourlyRate" placeholder="Enter hourly rate" step="0.01">
                    </div>
                    <button type="submit" class="btn">Add Expense</button>
                </form>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="calendar" class="tab-content">
            <h2>Activities & Daily Tracking</h2>
            
            <!-- Monthly Activity Summary -->
            <h3>Monthly Activity Summary</h3>
            <div class="grid">
                <div class="card">
                    <h3>Property Showings</h3>
                    <div class="number">5</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Listing Presentations</h3>
                    <div class="number">8</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Buyer Consultations</h3>
                    <div class="number">12</div>
                    <div class="label">This month</div>
                </div>
                <div class="card">
                    <h3>Closings</h3>
                    <div class="number">3</div>
                    <div class="label">This month</div>
                </div>
            </div>
            
            <!-- Two-column layout for daily inputs and activity tracking -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                
                <!-- Left Column: Daily Data Entry with Progress -->
                <div>
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Enter Today's Activity</h3>
                            <div id="lockStatus" style="font-weight: bold; color: #27ae60;">Unlocked</div>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="dailyDate" value="2025-07-17">
                        </div>
                        <div class="form-group">
                            <label>Hours Worked</label>
                            <input type="number" id="dailyHours" placeholder="Enter hours worked">
                        </div>
                        <div class="form-group">
                            <label>Calls Made</label>
                            <input type="number" id="dailyCalls" placeholder="Enter calls made">
                        </div>
                        <div class="form-group">
                            <label>Calls Answered</label>
                            <input type="number" id="dailyAnswered" placeholder="Enter calls answered">
                        </div>
                        <div class="form-group">
                            <label>Appointments Set</label>
                            <input type="number" id="dailyAppointments" placeholder="Enter appointments set">
                        </div>
                        <div class="form-group">
                            <label>Offers Written</label>
                            <input type="number" id="dailyOffers" placeholder="Enter offers written">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" id="saveDailyBtn" onclick="saveDailyData()">Save Daily Data</button>
                            <button class="btn" id="lockDailyBtn" onclick="lockDailyData()" style="background: #e74c3c;">Lock Today's Data</button>
                        </div>
                    </div>
                    
                    <!-- Real-time Progress Display moved here -->
                    <div class="form-section" style="margin-top: 20px; background: #f8f9fa; border: 1px solid #e9ecef;">
                        <h4 style="margin-top: 0; color: #495057;">Today's Progress vs Goals</h4>
                        <div id="progressDisplay">
                            <div class="progress-item">
                                <span>Hours Worked:</span>
                                <span id="hoursProgress">0 / 8 hours</span>
                                <div class="progress-bar"><div id="hoursBar" class="progress-fill" style="width: 0%"></div></div>
                            </div>
                            <div class="progress-item">
                                <span>Calls Made:</span>
                                <span id="callsProgress">0 / 20 calls</span>
                                <div class="progress-bar"><div id="callsBar" class="progress-fill" style="width: 0%"></div></div>
                            </div>
                            <div class="progress-item">
                                <span>Appointments Set:</span>
                                <span id="appointmentsProgress">0 / 3 appointments</span>
                                <div class="progress-bar"><div id="appointmentsBar" class="progress-fill" style="width: 0%"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Activity Tracking -->
                <div>
                    <div class="form-section">
                        <h3>Add Activity</h3>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="activityDate" value="2025-07-17">
                        </div>
                        <div class="form-group">
                            <label>Activity Type</label>
                            <select id="activityType">
                                <option>Property Showing</option>
                                <option>Listing Presentation</option>
                                <option>Buyer Consultation</option>
                                <option>Closing</option>
                                <option>Open House</option>
                                <option>Property Inspection</option>
                                <option>Market Analysis</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" id="activityClient" placeholder="Enter client name">
                        </div>
                        <div class="form-group">
                            <label>Property Address (Optional)</label>
                            <input type="text" id="activityProperty" placeholder="Enter property address">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="activityNotes" placeholder="Enter activity notes" rows="3"></textarea>
                        </div>
                        <button class="btn" onclick="addActivity()">Add Activity</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Reports & Analytics</h2>
            
            <div class="form-section">
                <h3>Generate Report</h3>
                <div class="form-group">
                    <label>Report Type</label>
                    <select id="reportType">
                        <option value="weekly">Weekly Summary</option>
                        <option value="monthly">Monthly Summary</option>
                        <option value="quarterly">Quarterly Review</option>
                        <option value="annual">Annual Report</option>
                        <option value="commission">Commission Summary</option>
                        <option value="expense">Expense Report</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>From Date</label>
                    <input type="date" id="reportFromDate">
                </div>
                <div class="form-group">
                    <label>To Date</label>
                    <input type="date" id="reportToDate">
                </div>
                <button class="btn" onclick="generateReport()">Generate Report</button>
                <button class="btn" onclick="printReport()" style="margin-left: 10px;">Print Report</button>
                <button class="btn" onclick="downloadPDF()" style="margin-left: 10px;">Download PDF</button>
            </div>
            
            <div id="reportOutput" style="display: none; margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white;">
                <div id="reportContent">
                    <!-- Generated report will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Property Expense Details Modal -->
    <div id="propertyExpenseModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closePropertyExpenseModal()">&times;</span>
            <h3>Property Expense Details</h3>
            <div id="propertyExpenseContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Dashboard data storage
        let dashboardData = {
            // Daily data storage with locking capability
            dailyData: {},
            
            // Goal locking system
            goalsLocked: false,
            lockedGoals: null,
            
            properties: [],
            nextPropertyId: 1,
            nextTransactionId: 1,
            nextExpenseId: 1,
            transactions: [
                {
                    id: 1,
                    date: "2025-07-15",
                    property: "123 Main St Concord",
                    amount: 1000000,
                    commission: 25000,
                    status: "Closed",
                    statusNote: ""
                },
                {
                    id: 2,
                    date: "2025-07-10",
                    property: "456 Oak Avenue",
                    amount: 425000,
                    commission: 10625,
                    status: "Closed",
                    statusNote: ""
                },
                {
                    id: 3,
                    date: "2025-07-05",
                    property: "789 Pine Road",
                    amount: 275000,
                    commission: 6875,
                    status: "Pending",
                    statusNote: ""
                }
            ],
            expenses: [],
            goals: {
                dailyCalls: 10,
                weeklyAppointments: 5,
                monthlyClosings: 2,
                monthlyOffers: 15,
                annualGCI: 215000
            },
            nextPropertyId: 9,
            nextTransactionId: 4,
            nextExpenseId: 1
        };

        // Global functions - these need to be accessible from onclick
        // Custom confirmation dialog to replace native confirm()
        function showCustomConfirmation(message, onConfirm, onCancel, options = {}) {
            const title = options.title || 'Confirm Removal';
            const confirmText = options.confirmText || 'Remove';
            const confirmColor = options.confirmColor || '#e74c3c';
            
            // Create modal elements
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <h3 style="margin-top: 0; color: ${confirmColor};">${title}</h3>
                    <p style="margin: 20px 0; font-size: 16px;">${message}</p>
                    <div style="margin-top: 30px;">
                        <button id="confirmBtn" style="background: ${confirmColor}; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer; font-size: 14px;">${confirmText}</button>
                        <button id="cancelBtn" style="background: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const confirmBtn = modal.querySelector('#confirmBtn');
            const cancelBtn = modal.querySelector('#cancelBtn');
            
            confirmBtn.onclick = function() {
                document.body.removeChild(modal);
                onConfirm();
            };
            
            cancelBtn.onclick = function() {
                document.body.removeChild(modal);
                if (onCancel) onCancel();
            };
            
            // Close on outside click
            modal.onclick = function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                    if (onCancel) onCancel();
                }
            };
            
            // Add to page
            document.body.appendChild(modal);
        }

        window.deleteProperty = function(propertyId) {
            console.log('Delete property called with ID:', propertyId, 'Type:', typeof propertyId);
            
            try {
                // Ensure propertyId is a number
                const id = parseInt(propertyId);
                console.log('Converted ID:', id);
                
                const property = dashboardData.properties.find(p => p.id === id);
                console.log('Found property:', property);
                console.log('All properties before deletion:', dashboardData.properties);
                
                if (!property) {
                    console.error('Property not found with ID:', id);
                    alert('Error: Property not found. Please refresh the page and try again.');
                    return;
                }
                
                // Use custom confirmation instead of native confirm()
                showCustomConfirmation(
                    `Are you sure you want to remove the property at ${property.address}?`,
                    function() {
                        // User confirmed - proceed with deletion
                        console.log('User confirmed deletion, removing property...');
                        
                        // Remove the property
                        dashboardData.properties = dashboardData.properties.filter(p => p.id !== id);
                        console.log('Properties after deletion:', dashboardData.properties);
                        
                        // Update all displays
                        renderPropertyTable();
                        updateDashboard();
                        updateReportsMetrics();
                        
                        console.log('Property removal completed successfully');
                    },
                    function() {
                        // User cancelled
                        console.log('User cancelled deletion');
                    }
                );
            } catch (error) {
                console.error('Error in deleteProperty function:', error);
                alert('An error occurred while trying to remove the property. Please try again.');
            }
        };

        window.editProperty = function(propertyId) {
            const id = parseInt(propertyId);
            const property = dashboardData.properties.find(p => p.id === id);
            if (!property) return;
            
            const row = document.querySelector(`tr:has(button[onclick="editProperty(${id})"])`);
            if (!row) return;
            
            row.innerHTML = `
                <td><input type="text" value="${property.address}" id="edit-address-${id}"></td>
                <td><input type="text" value="${property.client}" id="edit-client-${id}"></td>
                <td>
                    <select id="edit-type-${id}">
                        <option value="Buyer" ${property.type === 'Buyer' ? 'selected' : ''}>Buyer</option>
                        <option value="Seller" ${property.type === 'Seller' ? 'selected' : ''}>Seller</option>
                    </select>
                </td>
                <td><input type="number" value="${property.price}" id="edit-price-${id}"></td>
                <td>
                    <select id="edit-status-${id}">
                        <option value="Active" ${property.status === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="Active Listing" ${property.status === 'Active Listing' ? 'selected' : ''}>Active Listing</option>
                        <option value="Pending" ${property.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Under Contract" ${property.status === 'Under Contract' ? 'selected' : ''}>Under Contract</option>
                        <option value="In Progress" ${property.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Sold" ${property.status === 'Sold' ? 'selected' : ''}>Sold</option>
                        <option value="Closed" ${property.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        <option value="Expired" ${property.status === 'Expired' ? 'selected' : ''}>Expired</option>
                        <option value="Withdrawn" ${property.status === 'Withdrawn' ? 'selected' : ''}>Withdrawn</option>
                        <option value="Terminated" ${property.status === 'Terminated' ? 'selected' : ''}>Terminated</option>
                    </select>
                </td>
                <td><input type="text" value="${property.statusNote}" id="edit-note-${id}"></td>
                <td>
                    <button class="action-btn edit-btn" onclick="savePropertyEdit(${id})">Save</button>
                    <button class="action-btn cancel-btn" onclick="cancelEdit(${id})">Cancel</button>
                </td>
            `;
        };

        window.savePropertyEdit = function(propertyId) {
            const id = parseInt(propertyId);
            const property = dashboardData.properties.find(p => p.id === id);
            if (!property) return;
            
            const oldStatus = property.status;
            
            property.address = document.getElementById(`edit-address-${id}`).value;
            property.client = document.getElementById(`edit-client-${id}`).value;
            property.type = document.getElementById(`edit-type-${id}`).value;
            property.price = parseFloat(document.getElementById(`edit-price-${id}`).value);
            property.status = document.getElementById(`edit-status-${id}`).value;
            property.statusNote = document.getElementById(`edit-note-${id}`).value;
            
            // Auto-create transaction when property is marked as Closed
            if (oldStatus !== 'Closed' && property.status === 'Closed') {
                createAutoTransaction(property);
            }
            
            renderPropertyTable();
            updateDashboard();
            updateReportsMetrics();
            alert('Property updated successfully!');
        };

        function createAutoTransaction(property) {
            // Calculate commission (assuming 3% commission rate)
            const commissionRate = 0.03;
            const commission = property.price * commissionRate;
            
            const newTransaction = {
                id: dashboardData.nextTransactionId++,
                date: new Date().toISOString().split('T')[0],
                property: property.address,
                amount: property.price,
                commission: commission,
                status: 'Closed',
                statusNote: `Auto-generated from property closure`
            };
            
            dashboardData.transactions.push(newTransaction);
            renderTransactionTable();
            updateDashboard();
            
            alert(`Transaction automatically created for ${property.address}!\nVolume: $${property.price.toLocaleString()}\nCommission: $${commission.toLocaleString()}`);
        }

        function updateDashboard() {
            // Active listings (not sold or closed) - including "Active Listing" status
            const activeListings = dashboardData.properties.filter(p => 
                p.status === 'Active' || p.status === 'Active Listing' || p.status === 'Pending'
            ).length;
            
            // Status-specific counts
            const underContract = dashboardData.properties.filter(p => p.status === 'Under Contract').length;
            const expiredListings = dashboardData.properties.filter(p => p.status === 'Expired').length;
            const withdrawnListings = dashboardData.properties.filter(p => p.status === 'Withdrawn').length;
            const terminatedListings = dashboardData.properties.filter(p => p.status === 'Terminated').length;
            
            // Closed this month
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const closedThisMonth = dashboardData.transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            }).length;
            
            // Total volume and commission - only from closed transactions
            const closedTransactions = dashboardData.transactions.filter(t => t.status === 'Closed');
            const totalVolume = closedTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalCommission = closedTransactions.reduce((sum, t) => sum + t.commission, 0);
            
            // Average deal size - based on closed transactions only
            const averageDeal = closedTransactions.length > 0 ? totalVolume / closedTransactions.length : 0;
            
            // Total expenses
            const totalExpenses = dashboardData.expenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Net profit (commission - expenses)
            const netProfit = totalCommission - totalExpenses;
            
            // ROI calculation
            const roi = totalExpenses > 0 ? ((netProfit / totalExpenses) * 100) : 0;
            
            // GCI progress
            const annualGoal = dashboardData.goals.annualGCI || 215000;
            const gciProgress = annualGoal > 0 ? (totalCommission / annualGoal) * 100 : 0;
            
            // Activity counts (mock data - would need activity tracking system)
            const propertyShowings = 5; // This would come from activity data
            const listingPresentations = 8;
            const buyerConsultations = 12;
            const activityClosings = 3;
            
            // Update dashboard elements
            document.getElementById('activeListings').textContent = activeListings;
            document.getElementById('underContract').textContent = underContract;
            document.getElementById('expiredListings').textContent = expiredListings;
            document.getElementById('withdrawnListings').textContent = withdrawnListings;
            document.getElementById('terminatedListings').textContent = terminatedListings;
            document.getElementById('closedThisMonth').textContent = closedThisMonth;
            document.getElementById('totalVolume').textContent = `$${(totalVolume / 1000000).toFixed(1)}M`;
            document.getElementById('totalCommission').textContent = `$${(totalCommission / 1000).toFixed(0)}K`;
            document.getElementById('averageDeal').textContent = `$${(averageDeal / 1000).toFixed(0)}K`;
            document.getElementById('totalExpenses').textContent = `$${(totalExpenses / 1000).toFixed(1)}K`;
            document.getElementById('netProfit').textContent = `$${(netProfit / 1000).toFixed(0)}K`;
            document.getElementById('roi').textContent = `${roi.toFixed(1)}%`;
            document.getElementById('gciProgress').textContent = `${gciProgress.toFixed(1)}%`;
            
            // Update activity tiles
            document.getElementById('propertyShowings').textContent = propertyShowings;
            document.getElementById('listingPresentations').textContent = listingPresentations;
            document.getElementById('buyerConsultations').textContent = buyerConsultations;
            document.getElementById('activityClosings').textContent = activityClosings;
            
            // Update reports metrics
            updateReportsMetrics();
            
            // Update goal progress if goals are locked
            if (dashboardData.goalsLocked) {
                updateGoalProgress();
            }
        }

        function updateReportsMetrics() {
            // Calculate Conversion Rate: (Buyers/Sellers to closed) / Total Buyers/Sellers
            const totalBuyersSellers = dashboardData.properties.length;
            const closedDeals = dashboardData.properties.filter(p => p.status === 'Sold' || p.status === 'Closed').length;
            const conversionRate = totalBuyersSellers > 0 ? (closedDeals / totalBuyersSellers) * 100 : 0;
            
            // Calculate Average Days on Market: Under Contract to Closed
            const closedProperties = dashboardData.properties.filter(p => 
                (p.status === 'Sold' || p.status === 'Closed') && 
                p.underContractDate && 
                p.closedDate
            );
            
            let totalDays = 0;
            closedProperties.forEach(property => {
                const underContractDate = new Date(property.underContractDate);
                const closedDate = new Date(property.closedDate);
                const daysDiff = Math.floor((closedDate - underContractDate) / (1000 * 60 * 60 * 24));
                totalDays += daysDiff;
            });
            
            const avgDaysOnMarket = closedProperties.length > 0 ? Math.round(totalDays / closedProperties.length) : 0;
            
            // Update dashboard elements
            const conversionRateElement = document.getElementById('dashboardConversionRate');
            const avgDaysElement = document.getElementById('dashboardAvgDaysOnMarket');
            
            if (conversionRateElement) {
                conversionRateElement.textContent = `${conversionRate.toFixed(1)}%`;
            }
            if (avgDaysElement) {
                avgDaysElement.textContent = avgDaysOnMarket;
            }
        }

        window.cancelEdit = function(propertyId) {
            renderPropertyTable();
        };

        window.viewPropertyExpenses = function(propertyAddress) {
            const propertyExpenses = dashboardData.expenses.filter(expense => expense.property === propertyAddress);
            const modal = document.getElementById('propertyExpenseModal');
            const content = document.getElementById('propertyExpenseContent');
            
            let totalExpenses = 0;
            let expenseHtml = `<h4>Expenses for ${propertyAddress}</h4>`;
            
            if (propertyExpenses.length === 0) {
                expenseHtml += '<p>No expenses recorded for this property.</p>';
            } else {
                expenseHtml += '<table class="table"><thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Description</th></tr></thead><tbody>';
                
                propertyExpenses.forEach(expense => {
                    totalExpenses += expense.amount;
                    expenseHtml += `
                        <tr>
                            <td>${expense.date}</td>
                            <td>${expense.category}</td>
                            <td>$${expense.amount.toFixed(2)}</td>
                            <td>${expense.description || ''}</td>
                        </tr>
                    `;
                });
                
                expenseHtml += '</tbody></table>';
                expenseHtml += `<p><strong>Total Expenses: $${totalExpenses.toFixed(2)}</strong></p>`;
            }
            
            content.innerHTML = expenseHtml;
            modal.style.display = 'block';
        };

        window.closePropertyExpenseModal = function() {
            document.getElementById('propertyExpenseModal').style.display = 'none';
        };

        window.deleteTransaction = function(transactionId) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                dashboardData.transactions = dashboardData.transactions.filter(t => t.id !== transactionId);
                renderTransactionTable();
                alert('Transaction deleted successfully!');
            }
        };

        window.editTransaction = function(transactionId) {
            const transaction = dashboardData.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const row = document.querySelector(`tr:has(button[onclick="editTransaction(${transactionId})"])`);
            if (!row) return;
            
            row.innerHTML = `
                <td>${transaction.date}</td>
                <td>${transaction.property}</td>
                <td>$${transaction.amount.toLocaleString()}</td>
                <td>$${transaction.commission.toLocaleString()}</td>
                <td>
                    <select id="edit-status-${transactionId}">
                        <option value="Closed" ${transaction.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        <option value="Pending" ${transaction.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Under Contract" ${transaction.status === 'Under Contract' ? 'selected' : ''}>Under Contract</option>
                        <option value="In Progress" ${transaction.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Expired" ${transaction.status === 'Expired' ? 'selected' : ''}>Expired</option>
                        <option value="Withdrawn" ${transaction.status === 'Withdrawn' ? 'selected' : ''}>Withdrawn</option>
                        <option value="Terminated" ${transaction.status === 'Terminated' ? 'selected' : ''}>Terminated</option>
                    </select>
                </td>
                <td><input type="text" value="${transaction.statusNote || ''}" id="edit-note-${transactionId}" placeholder="Enter status note"></td>
                <td>
                    <button class="action-btn edit-btn" onclick="saveTransactionEdit(${transactionId})">Save</button>
                    <button class="action-btn cancel-btn" onclick="cancelTransactionEdit(${transactionId})">Cancel</button>
                </td>
            `;
        };

        window.saveTransactionEdit = function(transactionId) {
            const transaction = dashboardData.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            transaction.status = document.getElementById(`edit-status-${transactionId}`).value;
            transaction.statusNote = document.getElementById(`edit-note-${transactionId}`).value;
            
            renderTransactionTable();
            updateDashboard();
            alert('Transaction updated successfully!');
        };

        window.cancelTransactionEdit = function(transactionId) {
            renderTransactionTable();
        };

        window.deleteExpense = function(expenseId) {
            if (confirm('Are you sure you want to delete this expense?')) {
                dashboardData.expenses = dashboardData.expenses.filter(e => e.id !== expenseId);
                renderExpenseTable();
                updateDashboard();
                alert('Expense deleted successfully!');
            }
        };

        window.calculateMileageCost = function() {
            const mileage = parseFloat(document.getElementById('expenseMileage').value) || 0;
            const gasPrice = parseFloat(document.getElementById('expenseGasPrice').value) || 0;
            const mpg = parseFloat(document.getElementById('expenseMPG').value) || 20;
            
            if (mileage > 0 && gasPrice > 0 && mpg > 0) {
                const mileageCost = (mileage / mpg) * gasPrice;
                document.getElementById('expenseMileageCost').value = mileageCost.toFixed(2);
            }
        };

        window.calculateGCI = function() {
            const avgPrice = parseFloat(document.getElementById('avgPrice').value) || 0;
            const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;
            const gciGoal = parseFloat(document.getElementById('gciGoal').value) || 0;
            
            if (avgPrice > 0 && commissionRate > 0 && gciGoal > 0) {
                const commissionPerDeal = (avgPrice * commissionRate) / 100;
                const dealsNeeded = Math.ceil(gciGoal / commissionPerDeal);
                document.getElementById('dealsNeeded').value = dealsNeeded;
            }
        };

        window.saveDailyData = function() {
            const date = document.getElementById('dailyDate').value;
            const hours = parseFloat(document.getElementById('dailyHours').value) || 0;
            const callsMade = parseInt(document.getElementById('dailyCalls').value) || 0;
            const callsAnswered = parseInt(document.getElementById('dailyAnswered').value) || 0;
            const appointments = parseInt(document.getElementById('dailyAppointments').value) || 0;
            const offers = parseInt(document.getElementById('dailyOffers').value) || 0;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            // Check if data is locked
            if (dashboardData.dailyData[date] && dashboardData.dailyData[date].locked) {
                alert('This date is locked and cannot be modified.');
                return;
            }
            
            // Store daily data
            if (!dashboardData.dailyData[date]) {
                dashboardData.dailyData[date] = {};
            }
            
            dashboardData.dailyData[date] = {
                ...dashboardData.dailyData[date],
                date,
                hours,
                callsMade,
                callsAnswered,
                appointments,
                offers,
                timestamp: new Date().toISOString(),
                locked: dashboardData.dailyData[date]?.locked || false
            };
            
            // Update real-time progress
            updateProgressDisplay();
            
            alert(`Daily data saved for ${date}`);
        };

        window.lockDailyData = function() {
            const date = document.getElementById('dailyDate').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            // Show confirmation dialog
            showCustomConfirmation(
                `Are you sure you want to lock the data for ${date}? Once locked, this data cannot be modified.`,
                function() {
                    // User confirmed - lock the data
                    if (!dashboardData.dailyData[date]) {
                        // Save current data first
                        saveDailyData();
                    }
                    
                    dashboardData.dailyData[date].locked = true;
                    
                    // Update UI to show locked state
                    updateLockStatus(date);
                    
                    alert(`Data for ${date} has been locked successfully.`);
                },
                function() {
                    // User cancelled
                    console.log('User cancelled locking');
                }
            );
        };

        function updateLockStatus(date) {
            const lockStatus = document.getElementById('lockStatus');
            const lockBtn = document.getElementById('lockDailyBtn');
            const saveBtn = document.getElementById('saveDailyBtn');
            const inputs = ['dailyHours', 'dailyCalls', 'dailyAnswered', 'dailyAppointments', 'dailyOffers'];
            
            if (dashboardData.dailyData[date] && dashboardData.dailyData[date].locked) {
                lockStatus.textContent = 'LOCKED';
                lockStatus.style.color = '#e74c3c';
                lockBtn.style.display = 'none';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                
                // Disable all input fields
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = true;
                        input.style.background = '#f8f9fa';
                    }
                });
            } else {
                lockStatus.textContent = 'Unlocked';
                lockStatus.style.color = '#27ae60';
                lockBtn.style.display = 'inline-block';
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                
                // Enable all input fields
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = false;
                        input.style.background = '';
                    }
                });
            }
        }

        function updateProgressDisplay() {
            const date = document.getElementById('dailyDate').value;
            const data = dashboardData.dailyData[date];
            
            if (!data) return;
            
            // Daily goals (these could be made configurable)
            const goals = {
                hours: 8,
                calls: 20,
                appointments: 3
            };
            
            // Update hours progress
            const hoursPercent = Math.min((data.hours / goals.hours) * 100, 100);
            document.getElementById('hoursProgress').textContent = `${data.hours} / ${goals.hours} hours`;
            document.getElementById('hoursBar').style.width = hoursPercent + '%';
            
            // Update calls progress
            const callsPercent = Math.min((data.callsMade / goals.calls) * 100, 100);
            document.getElementById('callsProgress').textContent = `${data.callsMade} / ${goals.calls} calls`;
            document.getElementById('callsBar').style.width = callsPercent + '%';
            
            // Update appointments progress
            const appointmentsPercent = Math.min((data.appointments / goals.appointments) * 100, 100);
            document.getElementById('appointmentsProgress').textContent = `${data.appointments} / ${goals.appointments} appointments`;
            document.getElementById('appointmentsBar').style.width = appointmentsPercent + '%';
            
            // Update bar colors based on completion
            [
                { bar: 'hoursBar', percent: hoursPercent },
                { bar: 'callsBar', percent: callsPercent },
                { bar: 'appointmentsBar', percent: appointmentsPercent }
            ].forEach(item => {
                const bar = document.getElementById(item.bar);
                bar.className = 'progress-fill';
                if (item.percent >= 100) {
                    bar.classList.add('complete');
                } else if (item.percent > 100) {
                    bar.classList.add('over');
                }
            });
        }

        window.addActivity = function() {
            const date = document.getElementById('activityDate').value;
            const type = document.getElementById('activityType').value;
            const client = document.getElementById('activityClient').value;
            const property = document.getElementById('activityProperty').value;
            const notes = document.getElementById('activityNotes').value;
            
            if (!date || !type || !client) {
                alert('Please fill in all required fields (Date, Activity Type, Client Name)');
                return;
            }
            
            alert(`Activity added: ${type} for ${client} on ${date}`);
            
            // Reset form
            document.getElementById('activityDate').value = '';
            document.getElementById('activityType').selectedIndex = 0;
            document.getElementById('activityClient').value = '';
            document.getElementById('activityProperty').value = '';
            document.getElementById('activityNotes').value = '';
        };

        window.generateReport = function() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            // Filter data based on date range
            const filteredTransactions = dashboardData.transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            const filteredExpenses = dashboardData.expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            const filteredProperties = dashboardData.properties.filter(property => {
                // Include all properties for now - could add date filtering later
                return true;
            });
            
            // Generate report content
            const reportContent = generateReportContent(reportType, filteredTransactions, filteredExpenses, filteredProperties, startDate, endDate);
            
            // Display the report
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportOutput').style.display = 'block';
            
            // Scroll to the report
            document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
        };
        
        function generateReportContent(reportType, transactions, expenses, properties, startDate, endDate) {
            const formatDate = (date) => date.toLocaleDateString();
            const formatCurrency = (amount) => `$${amount.toLocaleString()}`;
            
            let content = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report</h2>
                    <p><strong>Period:</strong> ${formatDate(startDate)} to ${formatDate(endDate)}</p>
                    <p><strong>Generated:</strong> ${formatDate(new Date())}</p>
                </div>
            `;
            
            if (reportType === 'commission') {
                const closedTransactions = transactions.filter(t => t.status === 'Closed');
                const totalCommission = closedTransactions.reduce((sum, t) => sum + (t.commission || 0), 0);
                const totalVolume = closedTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                const avgCommission = closedTransactions.length > 0 ? totalCommission / closedTransactions.length : 0;
                
                content += `
                    <div style="margin-bottom: 20px;">
                        <h3>Commission Summary</h3>
                        <p><strong>Total Closed Transactions:</strong> ${closedTransactions.length}</p>
                        <p><strong>Total Volume:</strong> ${formatCurrency(totalVolume)}</p>
                        <p><strong>Total Commission:</strong> ${formatCurrency(totalCommission)}</p>
                        <p><strong>Average Commission:</strong> ${formatCurrency(avgCommission)}</p>
                    </div>
                `;
                
                if (closedTransactions.length > 0) {
                    content += `
                        <div style="margin-bottom: 20px;">
                            <h3>Commission Details</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Property</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Amount</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    closedTransactions.forEach(transaction => {
                        content += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${formatDate(new Date(transaction.date))}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${transaction.property}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(transaction.amount || 0)}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(transaction.commission || 0)}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } else if (reportType === 'expense') {
                const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const expensesByCategory = {};
                
                expenses.forEach(expense => {
                    const category = expense.category || 'Other';
                    expensesByCategory[category] = (expensesByCategory[category] || 0) + (expense.amount || 0);
                });
                
                content += `
                    <div style="margin-bottom: 20px;">
                        <h3>Expense Summary</h3>
                        <p><strong>Total Expenses:</strong> ${formatCurrency(totalExpenses)}</p>
                        <p><strong>Number of Expenses:</strong> ${expenses.length}</p>
                    </div>
                `;
                
                if (Object.keys(expensesByCategory).length > 0) {
                    content += `
                        <div style="margin-bottom: 20px;">
                            <h3>Expenses by Category</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Category</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Amount</th>
                                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    Object.entries(expensesByCategory).forEach(([category, amount]) => {
                        const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
                        content += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${category}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(amount)}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } else {
                // General report (weekly, monthly, quarterly, annual)
                const closedTransactions = transactions.filter(t => t.status === 'Closed');
                const totalRevenue = closedTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                const totalCommission = closedTransactions.reduce((sum, t) => sum + (t.commission || 0), 0);
                const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const netIncome = totalCommission - totalExpenses;
                
                content += `
                    <div style="margin-bottom: 20px;">
                        <h3>Financial Summary</h3>
                        <p><strong>Total Revenue:</strong> ${formatCurrency(totalRevenue)}</p>
                        <p><strong>Total Commission:</strong> ${formatCurrency(totalCommission)}</p>
                        <p><strong>Total Expenses:</strong> ${formatCurrency(totalExpenses)}</p>
                        <p><strong>Net Income:</strong> ${formatCurrency(netIncome)}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3>Activity Summary</h3>
                        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
                        <p><strong>Closed Transactions:</strong> ${closedTransactions.length}</p>
                        <p><strong>Total Properties:</strong> ${properties.length}</p>
                        <p><strong>Total Expenses Recorded:</strong> ${expenses.length}</p>
                    </div>
                `;
            }
            
            return content;
        }
        
        window.printReport = function() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            if (!reportContent.trim()) {
                alert('Please generate a report first');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };
        
        window.downloadPDF = function() {
            alert('To download as PDF: Use the Print function and select "Save as PDF" as your destination.');
        };

        // Simple tab switching function
        function switchTab(tabId, buttonElement) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const allButtons = document.querySelectorAll('.tab');
            allButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and activate button
            document.getElementById(tabId).classList.add('active');
            buttonElement.classList.add('active');
            
            // Re-render tables when switching to specific tabs
            if (tabId === 'transactions') {
                console.log('Switching to transactions tab - rendering tables');
                renderPropertyTable();
                renderTransactionTable();
            } else if (tabId === 'expenses') {
                renderExpenseTable();
                updatePropertyDropdowns(); // Update property dropdowns for expenses
            } else if (tabId === 'calendar') {
                updatePropertyDropdowns(); // Update property dropdowns for activities
            } else if (tabId === 'dashboard') {
                updateDashboard();
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (isDarkMode) {
                body.classList.remove('dark-mode');
                themeToggle.textContent = 'ðŸŒ“';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                body.classList.remove('dark-mode');
                themeToggle.textContent = 'ðŸŒ“';
            }
        }

        // Property management functions
        function renderPropertyTable() {
            console.log('renderPropertyTable called');
            const tableBody = document.getElementById('propertyTableBody');
            if (!tableBody) {
                console.error('Property table body not found');
                return;
            }
            
            console.log('Clearing table and re-rendering...');
            tableBody.innerHTML = '';
            console.log('Properties to render:', dashboardData.properties.length, dashboardData.properties);
            
            dashboardData.properties.forEach((property, index) => {
                console.log(`Rendering property ${index + 1}:`, property);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${property.address}</td>
                    <td>${property.client}</td>
                    <td>${property.type}</td>
                    <td>$${property.price.toLocaleString()}</td>
                    <td><span class="status ${property.status.toLowerCase().replace(/\s+/g, '-')}">${property.status}</span></td>
                    <td>${property.statusNote || ''}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editProperty(${property.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteProperty(${property.id})">Remove</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log('Table rendering completed. Total rows:', tableBody.children.length);
            
            // Update property dropdowns
            updatePropertyDropdowns();
        }

        function updatePropertyDropdowns() {
            const expensePropertySelect = document.getElementById('expenseProperty');
            const transactionPropertySelect = document.getElementById('transactionProperty');
            
            [expensePropertySelect, transactionPropertySelect].forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select property</option>';
                    dashboardData.properties.forEach(property => {
                        const option = document.createElement('option');
                        option.value = property.address;
                        option.textContent = property.address;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Goals management functions
        function updateGoals(event) {
            event.preventDefault();
            
            const dailyCalls = parseInt(document.getElementById('dailyCallGoal').value);
            const weeklyAppointments = parseInt(document.getElementById('weeklyAppointmentGoal').value);
            const monthlyClosings = parseInt(document.getElementById('monthlyClosingGoal').value);
            const monthlyOffers = parseInt(document.getElementById('monthlyOffersGoalInput').value);
            const annualGCI = parseInt(document.getElementById('annualGCIGoal').value);
            
            dashboardData.goals = {
                dailyCalls,
                weeklyAppointments,
                monthlyClosings,
                monthlyOffers,
                annualGCI
            };
            
            // Update the display cards
            document.getElementById('dailyGoal').textContent = dailyCalls;
            document.getElementById('weeklyGoal').textContent = weeklyAppointments;
            document.getElementById('monthlyGoal').textContent = monthlyClosings;
            document.getElementById('monthlyOffersGoal').textContent = monthlyOffers;
            document.getElementById('annualGCI').textContent = `$${(annualGCI / 1000).toFixed(0)}K`;
            
            alert('Goals updated successfully!');
        }

        // Transaction management functions
        function renderTransactionTable() {
            const tableBody = document.getElementById('transactionTableBody');
            tableBody.innerHTML = '';
            
            dashboardData.transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.property}</td>
                    <td>$${transaction.amount.toLocaleString()}</td>
                    <td>$${transaction.commission.toLocaleString()}</td>
                    <td><span class="status ${transaction.status.toLowerCase().replace(' ', '-')}">${transaction.status}</span></td>
                    <td>${transaction.statusNote || ''}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editTransaction(${transaction.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteTransaction(${transaction.id})">Delete</button>
                        <button class="action-btn view-btn" onclick="viewPropertyExpenses('${transaction.property}')">View Expenses</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update transaction summary
            updateTransactionSummary();
        }

        function updateTransactionSummary() {
            const totalTransactions = dashboardData.transactions.length;
            
            // Only include closed transactions in volume and commission calculations
            const closedTransactions = dashboardData.transactions.filter(t => t.status === 'Closed');
            const totalVolume = closedTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalCommission = closedTransactions.reduce((sum, t) => sum + t.commission, 0);
            const averageTransaction = closedTransactions.length > 0 ? totalVolume / closedTransactions.length : 0;
            
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('transactionTotalVolume').textContent = `$${(totalVolume / 1000000).toFixed(1)}M`;
            document.getElementById('commissionEarned').textContent = `$${(totalCommission / 1000).toFixed(0)}K`;
            document.getElementById('transactionAverageDeal').textContent = `$${(averageTransaction / 1000).toFixed(0)}K`;
        }

        function addCombined(event) {
            console.log('addCombined function called');
            if (event) {
                event.preventDefault();
            }
            
            // Get property information
            const address = document.getElementById('propertyAddress').value;
            const client = document.getElementById('clientName').value;
            const propertyType = document.getElementById('propertyType').value;
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value);
            const propertyStatus = document.getElementById('propertyStatus').value;
            const propertyStatusNote = document.getElementById('statusNote').value;
            
            console.log('Property data:', { address, client, propertyType, propertyPrice, propertyStatus, propertyStatusNote });
            
            // Validate required fields
            if (!address || !client || !propertyType || !propertyPrice || !propertyStatus) {
                alert('Please fill in all required fields.');
                return false;
            }
            
            // Create new property
            const newProperty = {
                id: dashboardData.nextPropertyId++,
                address,
                client,
                type: propertyType,
                price: propertyPrice,
                status: propertyStatus,
                statusNote: propertyStatusNote
            };
            
            console.log('New property created:', newProperty);
            
            // Add property to the data
            dashboardData.properties.push(newProperty);
            
            console.log('Property added to data. Total properties:', dashboardData.properties.length);
            
            // Update displays
            renderPropertyTable();
            updateDashboard();
            updateReportsMetrics();
            
            // Reset the form
            document.getElementById('combinedForm').reset();
            
            // Ensure we stay on the transactions tab
            switchTab('transactions', document.querySelector('button[onclick*="transactions"]'));
            
            alert('Property added successfully!');
            
            return false; // Ensure form doesn't submit
        }

        function addTransaction(event) {
            event.preventDefault();
            
            const date = document.getElementById('transactionDate').value;
            const property = document.getElementById('transactionProperty').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const commission = parseFloat(document.getElementById('transactionCommission').value);
            const status = document.getElementById('transactionStatus').value;
            const statusNote = document.getElementById('transactionStatusNote').value;
            
            const newTransaction = {
                id: dashboardData.nextTransactionId++,
                date,
                property,
                amount,
                commission,
                status,
                statusNote
            };
            
            dashboardData.transactions.push(newTransaction);
            renderTransactionTable();
            updateDashboard();
            document.getElementById('transactionForm').reset();
            
            alert('Transaction added successfully!');
        }

        function deleteTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                dashboardData.transactions = dashboardData.transactions.filter(t => t.id !== transactionId);
                renderTransactionTable();
                updateDashboard();
                alert('Transaction deleted successfully!');
            }
        }

        function addProperty(event) {
            event.preventDefault();
            
            const address = document.getElementById('propertyAddress').value;
            const client = document.getElementById('clientName').value;
            const type = document.getElementById('propertyType').value;
            const price = parseFloat(document.getElementById('propertyPrice').value);
            const status = document.getElementById('propertyStatus').value;
            const statusNote = document.getElementById('statusNote').value;
            
            const newProperty = {
                id: dashboardData.nextPropertyId++,
                address,
                client,
                type,
                price,
                status,
                statusNote
            };
            
            dashboardData.properties.push(newProperty);
            renderPropertyTable();
            updateDashboard();
            updateReportsMetrics();
            document.getElementById('propertyForm').reset();
            document.getElementById('propertyForm').reset();
            
            alert('Property added successfully!');
        }

        // Expense management functions
        function renderExpenseTable() {
            const tableBody = document.getElementById('expenseTableBody');
            tableBody.innerHTML = '';
            
            dashboardData.expenses.forEach(expense => {
                const row = document.createElement('tr');
                
                // Build detailed amount breakdown
                let amountBreakdown = [];
                let displayAmount = expense.amount || 0;
                
                if (expense.baseAmount > 0) {
                    amountBreakdown.push(`Base: $${expense.baseAmount.toFixed(2)}`);
                }
                
                if (expense.mileageCost > 0) {
                    amountBreakdown.push(`Gas: $${expense.mileageCost.toFixed(2)} (${expense.mileage} mi @ $${expense.gasPrice}/gal, ${expense.mpg} MPG)`);
                }
                
                if (expense.laborCost > 0) {
                    amountBreakdown.push(`Labor: $${expense.laborCost.toFixed(2)} (${expense.hoursWorked}h @ $${expense.hourlyRate}/h)`);
                }
                
                const amountNote = amountBreakdown.length > 0 ? ` (${amountBreakdown.join(', ')})` : '';
                
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.property}</td>
                    <td>${expense.category}</td>
                    <td>$${displayAmount.toFixed(2)}${amountNote}</td>
                    <td>${expense.description || ''}</td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteExpense(${expense.id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function addExpense(event) {
            event.preventDefault();
            
            const date = document.getElementById('expenseDate').value;
            const property = document.getElementById('expenseProperty').value;
            const category = document.getElementById('expenseCategory').value;
            const baseAmount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const description = document.getElementById('expenseDescription').value;
            const mileage = parseFloat(document.getElementById('expenseMileage').value) || 0;
            const gasPrice = parseFloat(document.getElementById('expenseGasPrice').value) || 0;
            const mpg = parseFloat(document.getElementById('expenseMPG').value) || 0;
            const mileageCost = parseFloat(document.getElementById('expenseMileageCost').value) || 0;
            const travelHours = parseFloat(document.getElementById('expenseTravelHours').value) || 0;
            const hourlyRate = parseFloat(document.getElementById('expenseHourlyRate').value) || 0;
            const hoursWorked = parseFloat(document.getElementById('expenseHoursWorked').value) || 0;
            
            // Calculate total expense: base amount + mileage cost + (hourly rate Ã— hours worked)
            const laborCost = hourlyRate * hoursWorked;
            const totalAmount = baseAmount + mileageCost + laborCost;
            
            const newExpense = {
                id: dashboardData.nextExpenseId++,
                date,
                property,
                category,
                amount: totalAmount,
                baseAmount,
                description,
                mileage,
                gasPrice,
                mpg,
                mileageCost,
                travelHours,
                hourlyRate,
                hoursWorked,
                laborCost
            };
            
            dashboardData.expenses.push(newExpense);
            renderExpenseTable();
            updateDashboard();
            document.getElementById('expenseForm').reset();
            
            alert('Expense added successfully!');
        }

        // Initialize page when loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set current timestamp
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
            
            // Set today's date in date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dailyDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('transactionDate').value = today;
            
            // Set today's date in activity date field (if it exists)
            const activityDate = document.getElementById('activityDate');
            if (activityDate) {
                activityDate.value = today;
            }
            
            // Initialize theme
            initializeTheme();
            
            // Load today's data if it exists
            loadTodaysData(today);
            
            // Render initial data
            renderPropertyTable();
            renderExpenseTable();
            renderTransactionTable();
            updateDashboard();
            updateReportsMetrics();
            
            // Add event listeners for real-time updates
            ['dailyHours', 'dailyCalls', 'dailyAnswered', 'dailyAppointments', 'dailyOffers'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        // Update progress in real-time as user types
                        const date = document.getElementById('dailyDate').value;
                        if (!dashboardData.dailyData[date]) {
                            dashboardData.dailyData[date] = {};
                        }
                        dashboardData.dailyData[date].hours = parseFloat(document.getElementById('dailyHours').value) || 0;
                        dashboardData.dailyData[date].callsMade = parseInt(document.getElementById('dailyCalls').value) || 0;
                        dashboardData.dailyData[date].appointments = parseInt(document.getElementById('dailyAppointments').value) || 0;
                        updateProgressDisplay();
                    });
                }
            });
            
            // Add date change listener
            document.getElementById('dailyDate').addEventListener('change', function() {
                const newDate = this.value;
                loadTodaysData(newDate);
            });
            
            // Add event listeners
            document.getElementById('expenseForm').addEventListener('submit', addExpense);
            document.getElementById('goalsForm').addEventListener('submit', updateGoals);
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('propertyExpenseModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        });

        function loadTodaysData(date) {
            const data = dashboardData.dailyData[date];
            
            if (data) {
                // Load saved data into form
                document.getElementById('dailyHours').value = data.hours || '';
                document.getElementById('dailyCalls').value = data.callsMade || '';
                document.getElementById('dailyAnswered').value = data.callsAnswered || '';
                document.getElementById('dailyAppointments').value = data.appointments || '';
                document.getElementById('dailyOffers').value = data.offers || '';
                
                // Update progress display
                updateProgressDisplay();
            } else {
                // Clear form for new date
                document.getElementById('dailyHours').value = '';
                document.getElementById('dailyCalls').value = '';
                document.getElementById('dailyAnswered').value = '';
                document.getElementById('dailyAppointments').value = '';
                document.getElementById('dailyOffers').value = '';
                
                // Reset progress display
                document.getElementById('hoursProgress').textContent = '0 / 8 hours';
                document.getElementById('callsProgress').textContent = '0 / 20 calls';
                document.getElementById('appointmentsProgress').textContent = '0 / 3 appointments';
                document.getElementById('hoursBar').style.width = '0%';
                document.getElementById('callsBar').style.width = '0%';
                document.getElementById('appointmentsBar').style.width = '0%';
            }
            
            // Update lock status
            updateLockStatus(date);
        }

        // Goal Locking and Progress Tracking Functions
        window.lockGoals = function() {
            showCustomConfirmation(
                'Are you sure you want to lock your goals? Once locked, goals cannot be changed and will be used for progress tracking.',
                function() {
                    // User confirmed - lock the goals
                    dashboardData.goalsLocked = true;
                    dashboardData.lockedGoals = {
                        dailyCalls: document.getElementById('dailyCallGoal').value,
                        weeklyAppointments: document.getElementById('weeklyAppointmentGoal').value,
                        monthlyClosings: document.getElementById('monthlyClosingGoal').value,
                        monthlyOffers: document.getElementById('monthlyOffersGoalInput').value,
                        annualGCI: document.getElementById('annualGCIGoal').value,
                        lockDate: new Date().toISOString()
                    };
                    
                    updateGoalsLockStatus();
                    
                    alert('Goals have been locked successfully. Progress tracking is now active!');
                },
                function() {
                    // User cancelled
                    console.log('User cancelled goal locking');
                },
                {
                    title: 'Confirm Goal Lock',
                    confirmText: 'Lock Goals',
                    confirmColor: '#27ae60'
                }
            );
        };

        function updateGoalsLockStatus() {
            const lockStatus = document.getElementById('goalsLockStatus');
            const lockBtn = document.getElementById('lockGoalsBtn');
            const goalInputs = ['dailyCallGoal', 'weeklyAppointmentGoal', 'monthlyClosingGoal', 'monthlyOffersGoalInput', 'annualGCIGoal'];
            
            if (dashboardData.goalsLocked) {
                lockStatus.textContent = 'LOCKED';
                lockStatus.style.color = '#e74c3c';
                lockBtn.style.display = 'none';
                
                // Disable all goal input fields
                goalInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = true;
                        input.style.background = '#f8f9fa';
                    }
                });
                
                // Start real-time progress tracking
                updateGoalProgress();
            } else {
                lockStatus.textContent = 'Unlocked';
                lockStatus.style.color = '#27ae60';
                lockBtn.style.display = 'inline-block';
                
                // Enable all goal input fields
                goalInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.disabled = false;
                        input.style.background = '';
                    }
                });
            }
        }

        function updateGoalProgress() {
            if (!dashboardData.goalsLocked || !dashboardData.lockedGoals) return;
            
            // Calculate current GCI from closed transactions
            const currentGCI = dashboardData.transactions
                .filter(t => t.status === 'Closed')
                .reduce((sum, t) => sum + (t.commission || 0), 0);
            
            const annualGoal = parseFloat(dashboardData.lockedGoals.annualGCI);
            const progress = annualGoal > 0 ? (currentGCI / annualGoal) * 100 : 0;
            const remaining = annualGoal - currentGCI;
            
            // Update dashboard GCI tile
            const formatCurrency = (amount) => {
                if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;
                if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;
                return `$${amount.toLocaleString()}`;
            };
            
            document.getElementById('annualGCIProgress').textContent = 
                `${formatCurrency(currentGCI)} / ${formatCurrency(annualGoal)}`;
            document.getElementById('gciProgressPercent').textContent = `${Math.round(progress)}%`;
            document.getElementById('gciProgressBar').style.width = `${Math.min(progress, 100)}%`;
            
            // Update GCI Calculator tab displays
            if (document.getElementById('currentGCIDisplay')) {
                document.getElementById('currentGCIDisplay').textContent = formatCurrency(currentGCI);
                document.getElementById('remainingGCIDisplay').textContent = formatCurrency(Math.max(remaining, 0));
                document.getElementById('gciProgressDisplay').textContent = `${Math.round(progress)}%`;
                document.getElementById('gciProgressFill').style.width = `${Math.min(progress, 100)}%`;
                document.getElementById('gciProgressText').textContent = 
                    `${Math.round(progress)}% Complete - ${formatCurrency(currentGCI)} of ${formatCurrency(annualGoal)} goal`;
            }
        }

        // Initialize goals lock status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateGoalsLockStatus();
            if (dashboardData.goalsLocked) {
                updateGoalProgress();
            }
        });
    </script>
</body>
</html>
