<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate KPI Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            padding: 20px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .tile {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .tile h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .tile p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #007bff;
        }
        .tile small {
            color: #666;
            font-size: 12px;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .timestamp {
            text-align: right;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const App = () => {
            // State Management with safe initialization
            const [activeTab, setActiveTab] = useState('goals');
            const [properties, setProperties] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('properties') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [expenses, setExpenses] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('expenses') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [hours, setHours] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('hours') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [showings, setShowings] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('showings') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [offers, setOffers] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('offers') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [listings, setListings] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('listings') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [buyers, setBuyers] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('buyers') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [lostDeals, setLostDeals] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('lostDeals') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [transactions, setTransactions] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('transactions') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            
            const [leads, setLeads] = useState(() => {
                try {
                    const storedLeads = JSON.parse(localStorage.getItem('leads') || '{}');
                    return storedLeads && 'sources' in storedLeads ? storedLeads : { 
                        total: 0, 
                        sources: { 'Social Media': 0, SOI: 0, Zillow: 0, OpCity: 0, Referral: 0, UpNest: 0, Homelight: 0, OneSuite: 0, 'Direct Mail': 0, Realtor: 0 } 
                    };
                } catch (e) {
                    return { 
                        total: 0, 
                        sources: { 'Social Media': 0, SOI: 0, Zillow: 0, OpCity: 0, Referral: 0, UpNest: 0, Homelight: 0, OneSuite: 0, 'Direct Mail': 0, Realtor: 0 } 
                    };
                }
            });
            
            const [calls, setCalls] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('calls') || '{"made": 0, "answered": 0}') || { made: 0, answered: 0 };
                } catch (e) {
                    return { made: 0, answered: 0 };
                }
            });
            const [marketingExpenses, setMarketingExpenses] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('marketingExpenses') || '[]') || [];
                } catch (e) {
                    return [];
                }
            });
            const [gciData, setGciData] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('gciData') || '{"gciGoal": 215000, "avgSale": 325090, "avgCommission": 0.025}') || { gciGoal: 215000, avgSale: 325090, avgCommission: 0.025 };
                } catch (e) {
                    return { gciGoal: 215000, avgSale: 325090, avgCommission: 0.025 };
                }
            });
            const [dailyInputs, setDailyInputs] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('dailyInputs') || '{}') || {};
                } catch (e) {
                    return {};
                }
            });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            // Save to localStorage whenever state changes
            useEffect(() => {
                try {
                    localStorage.setItem('properties', JSON.stringify(properties));
                } catch (e) {
                    console.warn('Failed to save properties:', e);
                }
            }, [properties]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                } catch (e) {
                    console.warn('Failed to save expenses:', e);
                }
            }, [expenses]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('hours', JSON.stringify(hours));
                } catch (e) {
                    console.warn('Failed to save hours:', e);
                }
            }, [hours]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('showings', JSON.stringify(showings));
                } catch (e) {
                    console.warn('Failed to save showings:', e);
                }
            }, [showings]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('offers', JSON.stringify(offers));
                } catch (e) {
                    console.warn('Failed to save offers:', e);
                }
            }, [offers]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('listings', JSON.stringify(listings));
                } catch (e) {
                    console.warn('Failed to save listings:', e);
                }
            }, [listings]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('buyers', JSON.stringify(buyers));
                } catch (e) {
                    console.warn('Failed to save buyers:', e);
                }
            }, [buyers]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('lostDeals', JSON.stringify(lostDeals));
                } catch (e) {
                    console.warn('Failed to save lostDeals:', e);
                }
            }, [lostDeals]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                } catch (e) {
                    console.warn('Failed to save transactions:', e);
                }
            }, [transactions]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('leads', JSON.stringify(leads));
                } catch (e) {
                    console.warn('Failed to save leads:', e);
                }
            }, [leads]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('calls', JSON.stringify(calls));
                } catch (e) {
                    console.warn('Failed to save calls:', e);
                }
            }, [calls]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('marketingExpenses', JSON.stringify(marketingExpenses));
                } catch (e) {
                    console.warn('Failed to save marketingExpenses:', e);
                }
            }, [marketingExpenses]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('gciData', JSON.stringify(gciData));
                } catch (e) {
                    console.warn('Failed to save gciData:', e);
                }
            }, [gciData]);
            
            useEffect(() => {
                try {
                    localStorage.setItem('dailyInputs', JSON.stringify(dailyInputs));
                } catch (e) {
                    console.warn('Failed to save dailyInputs:', e);
                }
            }, [dailyInputs]);
            
            // Helper functions for safe calculations
            const safeReduce = (array, reducer, initial) => {
                try {
                    return Array.isArray(array) ? array.reduce(reducer, initial) : initial;
                } catch (e) {
                    console.warn('Error in reduce operation:', e);
                    return initial;
                }
            };
            
            const safeFilter = (array, predicate) => {
                try {
                    return Array.isArray(array) ? array.filter(predicate) : [];
                } catch (e) {
                    console.warn('Error in filter operation:', e);
                    return [];
                }
            };
            
            const safeToFixed = (num, digits = 2) => {
                try {
                    return typeof num === 'number' && !isNaN(num) ? num.toFixed(digits) : '0.00';
                } catch (e) {
                    return '0.00';
                }
            };
            
            const safeToLocaleString = (num) => {
                try {
                    return typeof num === 'number' && !isNaN(num) ? num.toLocaleString() : '0';
                } catch (e) {
                    return '0';
                }
            };
            
            return (
                <div className="container">
                    <h1>Real Estate KPI Dashboard</h1>
                    <div className="timestamp">
                        <span>Last Updated: {new Date().toLocaleString()}</span>
                    </div>
                    
                    {/* Tabs */}
                    <div className="tabs">
                        <div 
                            className={`tab ${activeTab === 'goals' ? 'active' : ''}`}
                            onClick={() => setActiveTab('goals')}
                        >
                            Goals
                        </div>
                        <div 
                            className={`tab ${activeTab === 'properties' ? 'active' : ''}`}
                            onClick={() => setActiveTab('properties')}
                        >
                            Properties
                        </div>
                        <div 
                            className={`tab ${activeTab === 'transactions' ? 'active' : ''}`}
                            onClick={() => setActiveTab('transactions')}
                        >
                            Transactions
                        </div>
                        <div 
                            className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                            onClick={() => setActiveTab('dashboard')}
                        >
                            Dashboard
                        </div>
                        <div 
                            className={`tab ${activeTab === 'dataInput' ? 'active' : ''}`}
                            onClick={() => setActiveTab('dataInput')}
                        >
                            Daily Data Input
                        </div>
                        <div 
                            className={`tab ${activeTab === 'expensesHours' ? 'active' : ''}`}
                            onClick={() => setActiveTab('expensesHours')}
                        >
                            Expenses/Hours
                        </div>
                        <div 
                            className={`tab ${activeTab === 'calendar' ? 'active' : ''}`}
                            onClick={() => setActiveTab('calendar')}
                        >
                            Calendar
                        </div>
                        <div 
                            className={`tab ${activeTab === 'gci' ? 'active' : ''}`}
                            onClick={() => setActiveTab('gci')}
                        >
                            GCI Calculator
                        </div>
                        <div 
                            className={`tab ${activeTab === 'closedDeals' ? 'active' : ''}`}
                            onClick={() => setActiveTab('closedDeals')}
                        >
                            Closed Deals
                        </div>
                    </div>
                    
                    {/* Goals Tab */}
                    {activeTab === 'goals' && (
                        <div className="tab-content">
                            <h2>Goals & Targets</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Daily Goals</h4>
                                    <p>Calls: 10 | Hours: 8 | Appointments: 2</p>
                                    <small>Track your daily targets</small>
                                </div>
                                <div className="tile">
                                    <h4>Weekly Goals</h4>
                                    <p>Calls: 70 | Hours: 40 | Appointments: 10</p>
                                    <small>Track your weekly targets</small>
                                </div>
                                <div className="tile">
                                    <h4>Monthly Goals</h4>
                                    <p>Calls: 300 | Hours: 160 | Appointments: 40</p>
                                    <small>Track your monthly targets</small>
                                </div>
                                <div className="tile">
                                    <h4>Progress</h4>
                                    <p>75%</p>
                                    <small>Current month progress</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Properties Tab */}
                    {activeTab === 'properties' && (
                        <div className="tab-content">
                            <h2>Properties</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Total Properties</h4>
                                    <p>{Array.isArray(properties) ? properties.length : 0}</p>
                                    <small>Properties in your portfolio</small>
                                </div>
                                <div className="tile">
                                    <h4>Active Listings</h4>
                                    <p>{safeFilter(properties, p => p && p.status === 'Active').length}</p>
                                    <small>Currently active listings</small>
                                </div>
                                <div className="tile">
                                    <h4>Sold Properties</h4>
                                    <p>{safeFilter(properties, p => p && p.status === 'Sold').length}</p>
                                    <small>Successfully sold properties</small>
                                </div>
                                <div className="tile">
                                    <h4>Pending Sales</h4>
                                    <p>{safeFilter(properties, p => p && p.status === 'Pending').length}</p>
                                    <small>Properties under contract</small>
                                </div>
                            </div>
                            
                            <div className="form-section">
                                <h3>Add New Property</h3>
                                <div className="form-group">
                                    <label>Property Address</label>
                                    <input type="text" placeholder="Enter property address" />
                                </div>
                                <div className="form-group">
                                    <label>Client Name</label>
                                    <input type="text" placeholder="Enter client name" />
                                </div>
                                <div className="form-group">
                                    <label>Property Type</label>
                                    <select>
                                        <option value="Seller">Seller</option>
                                        <option value="Buyer">Buyer</option>
                                        <option value="Rental">Rental</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Price</label>
                                    <input type="number" placeholder="Enter price" />
                                </div>
                                <button className="btn">Add Property</button>
                            </div>
                        </div>
                    )}
                    
                    {/* Transactions Tab */}
                    {activeTab === 'transactions' && (
                        <div className="tab-content">
                            <h2>Transactions</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Total Transactions</h4>
                                    <p>{Array.isArray(transactions) ? transactions.length : 0}</p>
                                    <small>All transactions this year</small>
                                </div>
                                <div className="tile">
                                    <h4>Total Volume</h4>
                                    <p>${safeToLocaleString(safeReduce(transactions, (sum, t) => sum + (t && t.amount ? t.amount : 0), 0))}</p>
                                    <small>Total transaction volume</small>
                                </div>
                                <div className="tile">
                                    <h4>Commission Earned</h4>
                                    <p>${safeToLocaleString(safeReduce(transactions, (sum, t) => sum + (t && t.commission ? t.commission : 0), 0))}</p>
                                    <small>Total commission earned</small>
                                </div>
                                <div className="tile">
                                    <h4>Avg Transaction</h4>
                                    <p>${safeToLocaleString(transactions.length > 0 ? (safeReduce(transactions, (sum, t) => sum + (t && t.amount ? t.amount : 0), 0) / transactions.length) : 0)}</p>
                                    <small>Average transaction size</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Dashboard Tab */}
                    {activeTab === 'dashboard' && (
                        <div className="tab-content">
                            <h2>Dashboard Overview</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Today's Calls</h4>
                                    <p>{calls && calls.made ? calls.made : 0}</p>
                                    <small>Calls made today</small>
                                </div>
                                <div className="tile">
                                    <h4>Hours Worked</h4>
                                    <p>{safeReduce(hours, (sum, h) => sum + (h && h.hours ? h.hours : 0), 0)}</p>
                                    <small>Total hours this month</small>
                                </div>
                                <div className="tile">
                                    <h4>Appointments</h4>
                                    <p>{Array.isArray(showings) ? showings.length : 0}</p>
                                    <small>Scheduled appointments</small>
                                </div>
                                <div className="tile">
                                    <h4>Conversion Rate</h4>
                                    <p>65%</p>
                                    <small>Lead to appointment conversion</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Daily Data Input Tab */}
                    {activeTab === 'dataInput' && (
                        <div className="tab-content">
                            <h2>Daily Data Input</h2>
                            <div className="form-section">
                                <div className="form-group">
                                    <label>Date</label>
                                    <input 
                                        type="date" 
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Hours Worked</label>
                                    <input type="number" placeholder="Enter hours worked" />
                                </div>
                                <div className="form-group">
                                    <label>Calls Made</label>
                                    <input type="number" placeholder="Enter calls made" />
                                </div>
                                <div className="form-group">
                                    <label>Appointments Set</label>
                                    <input type="number" placeholder="Enter appointments set" />
                                </div>
                                <div className="form-group">
                                    <label>Offers Written</label>
                                    <input type="number" placeholder="Enter offers written" />
                                </div>
                                <button className="btn">Save Daily Data</button>
                            </div>
                        </div>
                    )}
                    
                    {/* Expenses/Hours Tab */}
                    {activeTab === 'expensesHours' && (
                        <div className="tab-content">
                            <h2>Expenses & Hours</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Total Expenses</h4>
                                    <p>${safeToLocaleString(safeReduce(expenses, (sum, e) => sum + (e && e.amount ? e.amount : 0), 0))}</p>
                                    <small>Total expenses this month</small>
                                </div>
                                <div className="tile">
                                    <h4>Marketing Expenses</h4>
                                    <p>${safeToLocaleString(safeReduce(marketingExpenses, (sum, e) => sum + (e && e.amount ? e.amount : 0), 0))}</p>
                                    <small>Marketing spend this month</small>
                                </div>
                                <div className="tile">
                                    <h4>Total Hours</h4>
                                    <p>{safeReduce(hours, (sum, h) => sum + (h && h.hours ? h.hours : 0), 0)}</p>
                                    <small>Total hours worked</small>
                                </div>
                                <div className="tile">
                                    <h4>Hourly Rate</h4>
                                    <p>${safeToFixed(safeReduce(transactions, (sum, t) => sum + (t && t.commission ? t.commission : 0), 0) / Math.max(safeReduce(hours, (sum, h) => sum + (h && h.hours ? h.hours : 0), 0), 1))}</p>
                                    <small>Effective hourly rate</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Calendar Tab */}
                    {activeTab === 'calendar' && (
                        <div className="tab-content">
                            <h2>Calendar & Appointments</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Today's Schedule</h4>
                                    <p>5 appointments</p>
                                    <small>Scheduled for today</small>
                                </div>
                                <div className="tile">
                                    <h4>This Week</h4>
                                    <p>12 appointments</p>
                                    <small>Scheduled this week</small>
                                </div>
                                <div className="tile">
                                    <h4>Next Week</h4>
                                    <p>8 appointments</p>
                                    <small>Scheduled next week</small>
                                </div>
                                <div className="tile">
                                    <h4>Show Rate</h4>
                                    <p>85%</p>
                                    <small>Appointment show rate</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* GCI Calculator Tab */}
                    {activeTab === 'gci' && (
                        <div className="tab-content">
                            <h2>GCI Calculator</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>GCI Goal</h4>
                                    <p>${safeToLocaleString(gciData && gciData.gciGoal ? gciData.gciGoal : 0)}</p>
                                    <small>Annual GCI target</small>
                                </div>
                                <div className="tile">
                                    <h4>Current GCI</h4>
                                    <p>${safeToLocaleString(safeReduce(transactions, (sum, t) => sum + (t && t.commission ? t.commission : 0), 0))}</p>
                                    <small>Year-to-date GCI</small>
                                </div>
                                <div className="tile">
                                    <h4>Remaining Goal</h4>
                                    <p>${safeToLocaleString(Math.max(0, (gciData && gciData.gciGoal ? gciData.gciGoal : 0) - safeReduce(transactions, (sum, t) => sum + (t && t.commission ? t.commission : 0), 0)))}</p>
                                    <small>Remaining to reach goal</small>
                                </div>
                                <div className="tile">
                                    <h4>Progress</h4>
                                    <p>{safeToFixed(((safeReduce(transactions, (sum, t) => sum + (t && t.commission ? t.commission : 0), 0) / Math.max(gciData && gciData.gciGoal ? gciData.gciGoal : 1, 1)) * 100), 1)}%</p>
                                    <small>Progress toward goal</small>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Closed Deals Tab */}
                    {activeTab === 'closedDeals' && (
                        <div className="tab-content">
                            <h2>Closed Deals</h2>
                            <div className="grid">
                                <div className="tile">
                                    <h4>Deals Closed</h4>
                                    <p>{safeFilter(transactions, t => t && t.status === 'Closed').length}</p>
                                    <small>Successfully closed deals</small>
                                </div>
                                <div className="tile">
                                    <h4>Total Volume</h4>
                                    <p>${safeToLocaleString(safeReduce(safeFilter(transactions, t => t && t.status === 'Closed'), (sum, t) => sum + (t && t.amount ? t.amount : 0), 0))}</p>
                                    <small>Closed transaction volume</small>
                                </div>
                                <div className="tile">
                                    <h4>Commission</h4>
                                    <p>${safeToLocaleString(safeReduce(safeFilter(transactions, t => t && t.status === 'Closed'), (sum, t) => sum + (t && t.commission ? t.commission : 0), 0))}</p>
                                    <small>Commission from closed deals</small>
                                </div>
                                <div className="tile">
                                    <h4>Avg Deal Size</h4>
                                    <p>${safeToLocaleString(safeFilter(transactions, t => t && t.status === 'Closed').length > 0 ? (safeReduce(safeFilter(transactions, t => t && t.status === 'Closed'), (sum, t) => sum + (t && t.amount ? t.amount : 0), 0) / safeFilter(transactions, t => t && t.status === 'Closed').length) : 0)}</p>
                                    <small>Average closed deal size</small>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
